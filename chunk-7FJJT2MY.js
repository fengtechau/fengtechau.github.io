import{$b as q,Ca as l,J as N,N as R,O as y,Pa as G,Sa as S,Sb as j,T as I,Tb as z,U as T,Ub as D,Vb as $,_ as F,a as w,ac as K,ba as L,bc as U,c as P,cc as H,db as h,dc as X,eb as r,ec as Y,fb as s,gb as A,gc as Z,h as E,hc as J,jb as k,jc as Q,kc as W,lb as u,lc as tt,mb as x,mc as et,pb as B,rb as p,sb as C,tb as _,u as O,vb as f,wb as b,yb as V}from"./chunk-4YE3RIQQ.js";var nt=(()=>{class a{constructor(t){this.zone=t,this.lookaheadMs=25,this.scheduleAheadTime=.12,this.clickMs=30,this.nextNoteTime=0,this.beatIndex=0,this.levelIndex=0,this.timerStartAt=0,this.stopwatchStartAt=0,this.stopwatchAccumulated=0,this.pattern=[],this.stateSubject=new E({isRunning:!1,bpm:120,timeSignature:"4/4",accentFirstBeat:!0,beatsPerBar:4,denominator:4,currentBeatIndex:0,currentLevelIndex:0,elapsedMs:0,groupingPreset:"none",accentBeats:[0],stopwatchRunning:!1}),this.state$=this.stateSubject.asObservable(),this.rebuildPattern()}applyPreset(t){let n=this.getState(),e=n.beatsPerBar,o=n.denominator;for(let i=0;i<e;i++)for(let d=0;d<this.pattern[i].length;d++)this.pattern[i][d]=d===0;if(t!=="mainOnly"){if(o===4){if(t==="allAnd"||t==="andAndSixteenth")for(let i=0;i<e;i++)this.pattern[i][2]=!0;if(t==="allSixteenth"||t==="andAndSixteenth")for(let i=0;i<e;i++)this.pattern[i][1]=!0,this.pattern[i][3]=!0}else if(t==="allSixteenth"||t==="andAndSixteenth")for(let i=0;i<e;i++)this.pattern[i][1]=!0}}getState(){return this.stateSubject.value}getPattern(){return this.pattern}getLevels(){let{denominator:t}=this.getState();return t===4?["q","e","s16a","s16b"]:["e","s16"]}getAvailableGroupings(){let t=this.getState();return t.denominator!==8?["none"]:t.beatsPerBar===6?["none","3+3","2+2+2"]:t.beatsPerBar===8?["none","2+2+2+2","3+3+2","2+3+3","3+2+3"]:["none"]}setBpm(t){t=Math.max(20,Math.min(300,Math.round(t))),this.patchState({bpm:t})}setTimeSignature(t){this.patchState({timeSignature:t}),this.rebuildPattern(),this.getState().isRunning&&this.resetTransport();let n=this.getState();if(n.denominator===8){let e=n.beatsPerBar===6?"3+3":n.beatsPerBar===8?"3+3+2":"none";this.setGrouping(e)}else this.setGrouping("none")}setAccentFirstBeat(t){this.patchState({accentFirstBeat:t})}setGrouping(t){this.patchState({groupingPreset:t});let n=this.computeAccentBeats(t);this.patchState({accentBeats:n})}computeAccentBeats(t){let{beatsPerBar:n,denominator:e}=this.getState();if(e!==8)return[0];if(t==="none")return[0];let o=t.split("+").map(c=>parseInt(c,10)).filter(c=>!isNaN(c)&&c>0),i=[],d=0;i.push(0);for(let c=0;c<o.length;c++)d+=o[c],d<n&&i.push(d);return Array.from(new Set(i)).filter(c=>c>=0&&c<n).sort((c,g)=>c-g)}toggleCell(t,n){!this.pattern[t]||this.pattern[t][n]===void 0||(this.pattern[t][n]=!this.pattern[t][n])}setAll(t){for(let n=0;n<this.pattern.length;n++)for(let e=0;e<this.pattern[n].length;e++)this.pattern[n][e]=t}start(){return P(this,null,function*(){this.getState().isRunning||(yield this.ensureAudio(),this.resetTransport(),this.patchState({isRunning:!0}),this.zone.runOutsideAngular(()=>{this.schedulerSub=O(this.lookaheadMs).subscribe(()=>this.schedulerTick())}))})}stop(){this.getState().isRunning&&(this.schedulerSub?.unsubscribe(),this.schedulerSub=void 0,this.patchState({isRunning:!1,currentBeatIndex:0,currentLevelIndex:0}))}toggle(){this.getState().isRunning?this.stop():this.start()}rebuildPattern(){let t=this.getState().timeSignature,[n,e]=t.split("/"),o=parseInt(n,10),i=parseInt(e,10),d=i===4?4:2;this.pattern=Array.from({length:o},()=>Array.from({length:d},(c,g)=>g===0)),this.patchState({beatsPerBar:o,denominator:i})}resetTransport(){let t=this.audioCtx?.currentTime??0;this.nextNoteTime=t+.05,this.beatIndex=0,this.levelIndex=0,this.patchState({currentBeatIndex:0,currentLevelIndex:0})}schedulerTick(){let t=this.audioCtx;for(;this.nextNoteTime<t.currentTime+this.scheduleAheadTime;)this.scheduleCurrentStep(this.nextNoteTime),this.advanceStep()}scheduleCurrentStep(t){let n=this.getState();if(!(this.pattern[this.beatIndex]?.[this.levelIndex]??!0)){this.zone.run(()=>{this.patchState({currentBeatIndex:this.beatIndex,currentLevelIndex:this.levelIndex})});return}let o=this.beatIndex===0,i=n.denominator===4?this.levelIndex===0:this.levelIndex===0,d=n.denominator===4?this.levelIndex===1:!1,c=n.denominator===4?this.levelIndex===2||this.levelIndex===3:this.levelIndex===1,g=880,M="square",v=.7;if(i){let it=n.denominator===8&&n.accentBeats?.includes(this.beatIndex),ot=o&&n.accentFirstBeat,at=it;M="square",ot?(g=1200,v=.95):at?(g=1e3,v=.82):(g=900,v=.72)}else d?(M="triangle",g=700,v=.55):c&&(M="sine",g=1e3,v=.35);this.playClick(t,g,M,v),this.zone.run(()=>{this.patchState({currentBeatIndex:this.beatIndex,currentLevelIndex:this.levelIndex})})}advanceStep(){let t=this.getState(),n=t.denominator===4?4:2,e=60/t.bpm,o=t.denominator===4?e/4:e/2;this.nextNoteTime+=o,this.levelIndex++,this.levelIndex>=n&&(this.levelIndex=0,this.beatIndex++,this.beatIndex>=t.beatsPerBar&&(this.beatIndex=0))}ensureAudio(){return P(this,null,function*(){this.audioCtx||(this.audioCtx=new AudioContext,this.masterGain=this.audioCtx.createGain(),this.masterGain.gain.value=.8,this.masterGain.connect(this.audioCtx.destination)),this.audioCtx.state==="suspended"&&(yield this.audioCtx.resume())})}playClick(t,n,e,o){let i=this.audioCtx,d=i.createOscillator(),c=i.createGain();d.type=e,d.frequency.setValueAtTime(n,t),c.gain.setValueAtTime(1e-4,t),c.gain.exponentialRampToValueAtTime(o,t+.002),c.gain.exponentialRampToValueAtTime(1e-4,t+this.clickMs/1e3),d.connect(c),c.connect(this.masterGain),d.start(t),d.stop(t+this.clickMs/1e3+.01)}toggleStopwatch(){this.getState().stopwatchRunning?this.pauseStopwatch():this.startStopwatch()}startStopwatch(){this.getState().stopwatchRunning||(this.stopwatchStartAt=performance.now(),this.patchState({stopwatchRunning:!0}),this.stopwatchSub?.unsubscribe(),this.zone.runOutsideAngular(()=>{this.stopwatchSub=O(100).subscribe(()=>{let t=this.stopwatchAccumulated+(performance.now()-this.stopwatchStartAt);this.zone.run(()=>this.patchState({elapsedMs:t}))})}))}pauseStopwatch(){this.getState().stopwatchRunning&&(this.stopwatchAccumulated+=performance.now()-this.stopwatchStartAt,this.stopwatchSub?.unsubscribe(),this.stopwatchSub=void 0,this.patchState({stopwatchRunning:!1,elapsedMs:this.stopwatchAccumulated}))}resetStopwatch(){this.stopwatchSub?.unsubscribe(),this.stopwatchSub=void 0,this.stopwatchAccumulated=0,this.stopwatchStartAt=0,this.patchState({stopwatchRunning:!1,elapsedMs:0})}patchState(t){this.stateSubject.next(w(w({},this.stateSubject.value),t))}static{this.\u0275fac=function(n){return new(n||a)(R(F))}}static{this.\u0275prov=N({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();function st(a,m){if(a&1&&(r(0,"option",32),p(1),s()),a&2){let t=m.$implicit;h("value",t),l(),C(t)}}function lt(a,m){if(a&1&&(r(0,"option",33),p(1),f(2,"translate"),s()),a&2){let t=m.$implicit;h("ngValue",t.value),l(),_(" ",b(2,2,t.labelKey)," ")}}function ct(a,m){if(a&1&&(r(0,"option",32),p(1),s()),a&2){let t=m.$implicit;h("value",t),l(),C(t)}}function pt(a,m){if(a&1){let t=k();r(0,"div",34)(1,"div",35)(2,"select",36),u("ngModelChange",function(e){I(t);let o=x();return T(o.onGroupingChange(e))}),S(3,ct,2,2,"option",10),s(),r(4,"div",37),p(5),f(6,"translate"),s()()()}if(a&2){let t=x();l(2),h("ngModel",t.state().groupingPreset),l(),h("ngForOf",t.groupings()),l(2),_(" ",b(6,3,"GROUPING_HINT")," ")}}function dt(a,m){if(a&1){let t=k();r(0,"button",40),u("click",function(){let e=I(t).index,o=x().index,i=x();return T(i.toggleCell(o,e))}),r(1,"span",41),p(2),s()()}if(a&2){let t=m.index,n=x().index,e=x();B("off",!e.pattern[n][t]),h("ngClass",e.levelClass(t)),l(2),C(e.cellText(n,t))}}function ht(a,m){if(a&1&&(r(0,"div",38),S(1,dt,3,4,"button",39),s()),a&2){let t=m.$implicit,n=m.index,e=x();B("active-now",e.isBeatActiveNow(n)),l(),h("ngForOf",t)}}var Pt=(()=>{class a{applyPreset(t){this.metro.applyPreset(t)}isBeatActiveNow(t){let n=this.state();return n.isRunning&&n.currentBeatIndex===t}constructor(){this.metro=y(nt),this.i18n=y(q),this.state=L(this.metro.getState()),this.sub=this.metro.state$.subscribe(t=>this.state.set(t)),this.timeSignatures=["2/4","3/4","4/4","4/8","6/8","8/8"],this.levels=V(()=>this.state().denominator===4?["1/4","1/8","1/16","1/16"]:["1/8","1/16"]),this.presetOptions=[{value:"mainOnly",labelKey:"PRESET_MAIN_ONLY"},{value:"allAnd",labelKey:"PRESET_ALL_AND"},{value:"allSixteenth",labelKey:"PRESET_ALL_SIXTEENTH"},{value:"andAndSixteenth",labelKey:"PRESET_AND_AND_SIXTEENTH"}],this.selectedPreset="mainOnly",this.i18n.use("en")}ngOnDestroy(){this.sub.unsubscribe()}toggle(){this.metro.toggle()}stop(){this.metro.stop()}onBpmChange(t){this.metro.setBpm(t)}onSigChange(t){this.metro.setTimeSignature(t)}onPresetChange(t){let e=t.target?.value;e&&this.applyPreset(e)}onAccentChange(t){this.metro.setAccentFirstBeat(t)}toggleCell(t,n){this.metro.toggleCell(t,n)}get pattern(){return this.metro.getPattern()}setLang(t){this.i18n.use(t)}formatElapsed(t){let n=Math.floor(t/1e3),e=Math.floor(n/60),o=n%60,i=Math.floor(t%1e3/100);return`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}.${i}`}isPlayingCell(t,n){let e=this.state();return e.isRunning&&e.currentBeatIndex===t&&e.currentLevelIndex===n}groupings(){return this.metro.getAvailableGroupings()}onGroupingChange(t){this.metro.setGrouping(t)}cellText(t,n){return this.state().denominator===4?n===0?String(t+1):n===1?"e":n===2?"and":"r":n===0?String(t+1):"a"}levelClass(t){return this.state().denominator===4?["lvl-main","lvl-e","lvl-and","lvl-r"][t]??"":t===0?"lvl-main":"lvl-a"}isBeatActive(t){let n=this.pattern?.[t];return!!n&&n.some(e=>e)}bpmMinus(){this.metro.setBpm(this.state().bpm-1)}bpmPlus(){this.metro.setBpm(this.state().bpm+1)}toggleStopwatch(){this.metro.toggleStopwatch()}resetStopwatch(){this.metro.resetStopwatch()}static{this.\u0275fac=function(n){return new(n||a)}}static{this.\u0275cmp=G({type:a,selectors:[["app-metronome"]],decls:58,vars:30,consts:[[1,"container","py-2","metronome-wrap"],[1,"d-flex","justify-content-between","align-items-center","mb-2"],[1,"m-0"],[1,"fa-solid","fa-music","me-2"],[1,"d-flex","align-items-center","gap-1"],[1,"btn","btn-outline-secondary","btn-sm","px-2",3,"click"],[1,"row","g-2","align-items-center"],[1,"col-12","col-md-6","d-flex","align-items-center","gap-2","flex-wrap"],[1,"form-label","small","mb-0","sig-label"],[1,"form-select","form-select-sm","sig-select",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"btn","btn-primary","btn-sm","play-btn",3,"click"],[1,"btn","btn-outline-danger","btn-sm","stop-btn",3,"click"],[1,"form-select","form-select-sm","preset-select",3,"ngModelChange","ngModel"],[3,"ngValue",4,"ngFor","ngForOf"],["class","col-12 col-md-6",4,"ngIf"],[1,"col-12"],[1,"d-flex","justify-content-between","align-items-center","mb-1"],[1,"small"],[1,"tempo-row"],[1,"btn","btn-outline-secondary","btn-circle",3,"click"],["type","range","min","20","max","300",1,"form-range","tempo-range",3,"ngModelChange","ngModel"],[1,"form-check","small"],["id","accent","type","checkbox",1,"form-check-input",3,"ngModelChange","ngModel"],["for","accent",1,"form-check-label"],[1,"mt-2"],[1,"grid-outer"],["class","beat-col",3,"active-now",4,"ngFor","ngForOf"],[1,"timer-badge"],[1,"timer-text"],[1,"fa-regular","fa-clock","me-1"],[1,"btn","btn-light","btn-xs",3,"click"],[3,"value"],[3,"ngValue"],[1,"col-12","col-md-6"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"form-select","form-select-sm","grouping-select",3,"ngModelChange","ngModel"],[1,"form-text","tiny-hint","m-0"],[1,"beat-col"],["type","button","class","cell",3,"ngClass","off","click",4,"ngFor","ngForOf"],["type","button",1,"cell",3,"click","ngClass"],[1,"cell-label"]],template:function(n,e){n&1&&(r(0,"div",0)(1,"div",1)(2,"h5",2),A(3,"i",3),p(4),f(5,"translate"),s(),r(6,"div",4)(7,"button",5),u("click",function(){return e.setLang("en")}),p(8,"EN"),s(),r(9,"button",5),u("click",function(){return e.setLang("zh")}),p(10,"\u4E2D\u6587"),s()()(),r(11,"div",6)(12,"div",7)(13,"label",8),p(14),f(15,"translate"),s(),r(16,"select",9),u("ngModelChange",function(i){return e.onSigChange(i)}),S(17,st,2,2,"option",10),s(),r(18,"button",11),u("click",function(){return e.toggle()}),p(19),f(20,"translate"),f(21,"translate"),s(),r(22,"button",12),u("click",function(){return e.stop()}),p(23," Stop "),s(),r(24,"select",13),u("ngModelChange",function(i){return e.selectedPreset=i,e.applyPreset(i)}),S(25,lt,3,4,"option",14),s()(),S(26,pt,7,5,"div",15),r(27,"div",16)(28,"div",17)(29,"div",18),p(30),f(31,"translate"),r(32,"strong"),p(33),s()()(),r(34,"div",19)(35,"button",20),u("click",function(){return e.bpmMinus()}),p(36,"\u2212"),s(),r(37,"input",21),u("ngModelChange",function(i){return e.onBpmChange(i)}),s(),r(38,"button",20),u("click",function(){return e.bpmPlus()}),p(39,"+"),s()()(),r(40,"div",16)(41,"div",22)(42,"input",23),u("ngModelChange",function(i){return e.onAccentChange(i)}),s(),r(43,"label",24),p(44),f(45,"translate"),s()()()(),r(46,"div",25)(47,"div",26),S(48,ht,2,3,"div",27),s()(),r(49,"div",28)(50,"span",29),A(51,"i",30),p(52),s(),r(53,"button",31),u("click",function(){return e.toggleStopwatch()}),p(54),f(55,"translate"),s(),r(56,"button",31),u("click",function(){return e.resetStopwatch()}),p(57," Reset "),s()()()),n&2&&(l(4),_("",b(5,16,"TITLE")," "),l(10),C(b(15,18,"SIG")),l(2),h("ngModel",e.state().timeSignature),l(),h("ngForOf",e.timeSignatures),l(2),_(" ",e.state().isRunning?b(20,20,"PAUSE"):b(21,22,"PLAY")," "),l(5),h("ngModel",e.selectedPreset),l(),h("ngForOf",e.presetOptions),l(),h("ngIf",e.state().denominator===8),l(4),_(" ",b(31,24,"BPM"),": "),l(3),C(e.state().bpm),l(4),h("ngModel",e.state().bpm),l(5),h("ngModel",e.state().accentFirstBeat),l(2),_(" ",b(45,26,"ACCENT_FIRST")," "),l(4),h("ngForOf",e.pattern),l(4),_("",e.formatElapsed(e.state().elapsedMs)," "),l(2),_(" ",e.state().stopwatchRunning?b(55,28,"PAUSE"):"Start"," "))},dependencies:[$,j,z,D,et,W,tt,X,J,H,Q,Y,Z,U,K],styles:['@charset "UTF-8";.metronome-wrap[_ngcontent-%COMP%], .grid-outer[_ngcontent-%COMP%]{background:#fff}.sig-label[_ngcontent-%COMP%]{min-width:40px;color:#0009}.sig-select[_ngcontent-%COMP%]{width:140px}.play-btn[_ngcontent-%COMP%]{min-width:110px;white-space:nowrap;padding:.35rem .9rem}.stop-btn[_ngcontent-%COMP%]{min-width:72px;white-space:nowrap}.preset-select[_ngcontent-%COMP%]{width:210px;white-space:nowrap}.grouping-select[_ngcontent-%COMP%]{width:160px}.tiny-hint[_ngcontent-%COMP%]{font-size:11px;opacity:.75}.tempo-row[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.btn-circle[_ngcontent-%COMP%]{width:34px;height:34px;border-radius:999px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-weight:800;line-height:1}.tempo-range[_ngcontent-%COMP%]{flex:1;margin:0}.grid-outer[_ngcontent-%COMP%]{display:flex;gap:8px;overflow-x:auto;padding:6px;border:none}.beat-col[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:0;padding:0;background:#fff;border:none;border-radius:10px;min-width:54px}.beat-col.active-now[_ngcontent-%COMP%]{background:#ffa14a2e}.cell[_ngcontent-%COMP%]{width:100%;height:28px;border:none;border-radius:0;background:#fff;padding:0}.beat-col[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:first-child{border-top-left-radius:10px;border-top-right-radius:10px}.beat-col[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:last-child{border-bottom-left-radius:10px;border-bottom-right-radius:10px}.cell-label[_ngcontent-%COMP%]{font-size:12px;font-weight:700;color:#111;-webkit-user-select:none;user-select:none}.cell.off[_ngcontent-%COMP%]{background:#fff}.cell.off[_ngcontent-%COMP%]   .cell-label[_ngcontent-%COMP%]{color:#fff}[_ngcontent-%COMP%]:root{--orange-main: #ff6a00;--orange-and: #ff9a3d;--orange-light: #ffd6b3}.beat-col.active-now[_ngcontent-%COMP%]   .cell.lvl-main[_ngcontent-%COMP%]:not(.off){background:var(--orange-main)}.beat-col.active-now[_ngcontent-%COMP%]   .cell.lvl-and[_ngcontent-%COMP%]:not(.off), .beat-col.active-now[_ngcontent-%COMP%]   .cell.lvl-a[_ngcontent-%COMP%]:not(.off){background:var(--orange-and)}.beat-col.active-now[_ngcontent-%COMP%]   .cell.lvl-e[_ngcontent-%COMP%]:not(.off), .beat-col.active-now[_ngcontent-%COMP%]   .cell.lvl-r[_ngcontent-%COMP%]:not(.off){background:var(--orange-light)}.beat-col.active-now[_ngcontent-%COMP%]   .cell.lvl-main[_ngcontent-%COMP%]:not(.off)   .cell-label[_ngcontent-%COMP%]{color:#111}.beat-col.active-now[_ngcontent-%COMP%]   .cell[_ngcontent-%COMP%]:not(.off)   .cell-label[_ngcontent-%COMP%]{color:#111}.timer-badge[_ngcontent-%COMP%]{position:fixed;right:10px;bottom:10px;z-index:999;display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#000000b8;color:#fff;font-size:12px}.timer-text[_ngcontent-%COMP%]{font-variant-numeric:tabular-nums}.btn-xs[_ngcontent-%COMP%]{padding:2px 10px;font-size:12px;line-height:1.4;border-radius:999px;white-space:nowrap}@media(max-width:576px){.sig-select[_ngcontent-%COMP%]{width:150px}.play-btn[_ngcontent-%COMP%]{min-width:120px}.preset-select[_ngcontent-%COMP%]{width:200px}.beat-col[_ngcontent-%COMP%]{min-width:52px}.cell[_ngcontent-%COMP%]{height:30px}}']})}}return a})();export{Pt as MetronomeComponent};
